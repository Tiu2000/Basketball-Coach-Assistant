<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Stat Recorder</title>
    <style>
        :root { --bg: #222; --text: white; --card: #333; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display:flex; flex-direction:column; height:100vh; overflow:hidden;}
        
        .header { 
            background: #111; padding: 10px 20px; border-bottom: 2px solid #444; 
            display: flex; justify-content: space-between; align-items: center; 
            flex-shrink: 0; z-index: 100;
        }
        
        /* SCOREBOARD STYLES */
        .scoreboard-area { display: flex; align-items: center; gap: 20px; background: #000; padding: 5px 15px; border-radius: 8px; border: 1px solid #444; }
        .score-group { text-align: center; }
        .score-val { font-size: 1.8rem; font-weight: bold; color: #fff; }
        .score-label { font-size: 0.7rem; color: #888; letter-spacing: 1px; }
        
        /* GUEST CONTROLS */
        .guest-controls { display: flex; gap: 2px; margin-top: 2px; }
        .btn-guest { padding: 2px 6px; font-size: 0.7rem; background: #444; color: white; border: none; cursor: pointer; border-radius: 2px; }
        .btn-guest:hover { background: #666; }

        .clock-badge {
            background: #222; border: 1px solid #444; border-radius: 4px; 
            padding: 5px 10px; font-family: monospace; font-size: 1.2rem; color: #888;
            display: flex; align-items: center; gap: 10px;
        }
        .clock-badge.live { border-color: #00e676; color: white; }
        .dot { height: 8px; width: 8px; border-radius: 50%; background: #c62828; }
        .clock-badge.live .dot { background: #00e676; box-shadow: 0 0 5px #00e676; }

        .main { display: flex; flex: 1; overflow: hidden; }
        .roster-area { flex: 3; padding: 20px; overflow-y: auto; border-right: 1px solid #444; }
        .log-area { flex: 1; background: #181818; display: flex; flex-direction: column; border-left: 1px solid #333; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .card { 
            background: var(--card); padding: 15px; border-radius: 8px; text-align: center; 
            cursor: pointer; border: 2px solid transparent; transition: all 0.2s; user-select: none;
        }
        .card:hover { background: #444; transform: translateY(-3px); }
        .card.selected { background: #263238; border-color: #ff6f00; transform: scale(1.05); box-shadow: 0 0 15px rgba(255,111,0,0.3); }
        
        .card.fouled-out { border-color: #c62828; background: #3e2723; opacity: 0.8; }
        .card.fouled-out h3 { color: #ff8a80; }

        .controls { 
            background: #111; padding: 15px; display: grid; 
            grid-template-columns: repeat(6, 1fr); gap: 8px; border-top: 1px solid #444; 
        }
        .btn { padding: 15px; border:none; border-radius:4px; font-weight:bold; color:white; cursor:pointer; font-size:1rem; position: relative; }
        .c-pts { background: #ff6f00; }
        .c-miss { background: #c62828; }
        .c-stat { background: #2e7d32; }
        .c-bad { background: #424242; }
        .c-chart { background: #673ab7; grid-column: span 1; display:flex; align-items:center; justify-content:center; gap:5px; }
        
        /* Keyboard Shortcut Hint */
        .key-hint { 
            position: absolute; top: 2px; right: 4px; font-size: 0.65rem; 
            background: rgba(0,0,0,0.3); padding: 1px 4px; border-radius: 3px; color: #ddd; 
        }

        #logs { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; font-family: monospace; font-size: 0.85rem; }
        #logs li { padding: 6px 10px; border-bottom: 1px solid #333; color: #ccc; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 15px; border-radius: 8px; text-align: center; color: black; width: 350px; }
        canvas { background: #e0bb86; border: 3px solid #333; cursor: crosshair; display: block; margin: 10px auto; }
        .modal-header { font-weight: bold; margin-bottom: 5px; font-size: 1.2rem; }

        @media print {
            body { background: white; color: black; height: auto; overflow: visible; }
            .header, .controls, #selection-msg, .c-chart { display: none !important; }
            .roster-area { width: 100%; border: none; }
            .card { border: 1px solid #ccc; color: black; background: white; break-inside: avoid; }
            .log-area { display: block; border: 1px solid #ccc; margin-top: 20px; height: auto; }
            #logs li { color: black; border-color: #eee; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="scoreboard-area">
            <div class="score-group">
                <div class="score-label">HOME</div>
                <div class="score-val" id="score-home">0</div>
            </div>
            <div style="color:#555; font-size:1.2rem">:</div>
            <div class="score-group">
                <div class="score-label">GUEST</div>
                <div class="score-val" id="score-guest">0</div>
                <div class="guest-controls">
                    <button class="btn-guest" onclick="adjGuest(1)">+1</button>
                    <button class="btn-guest" onclick="adjGuest(2)">+2</button>
                    <button class="btn-guest" onclick="adjGuest(3)">+3</button>
                    <button class="btn-guest" onclick="adjGuest(-1)">-1</button>
                </div>
            </div>
        </div>
        
        <div class="clock-badge" id="banner-clock">
            <div class="dot"></div> <span id="time-text">--:--</span>
        </div>

        <div>
            <button onclick="exportCSV()" style="padding:6px 10px; border:none; background:#00838f; color:white; border-radius:4px; cursor:pointer; font-size:0.8rem">üíæ Export</button>
            <button onclick="window.print()" style="padding:6px 10px; border:none; background:#616161; color:white; border-radius:4px; cursor:pointer; font-size:0.8rem">üñ®Ô∏è Print</button>
        </div>
    </div>

    <div class="main">
        <div class="roster-area">
            <div id="selection-msg" style="text-align:center; color:#888; margin-bottom:15px; border:1px dashed #444; padding:10px;">
                üëÜ Click a player (or type Name) to select
            </div>
            <div class="grid" id="roster-grid"></div>
        </div>
        <div class="log-area">
            <div style="padding:10px; background:#222; font-weight:bold; text-align:center; border-bottom:1px solid #444">Game Log</div>
            <ul id="logs"></ul>
        </div>
    </div>

    <div class="controls">
        <button class="btn c-pts" onclick="triggerShot(1, 'fg')">1 PT <span class="key-hint">1</span></button>
        <button class="btn c-pts" onclick="triggerShot(2, 'fg')">2 PT <span class="key-hint">2</span></button>
        <button class="btn c-pts" onclick="triggerShot(3, 'fg')">3 PT <span class="key-hint">3</span></button>
        <button class="btn c-miss" onclick="triggerShot(0, 'miss')">MISS <span class="key-hint">0/M</span></button>
        
        <button class="btn c-bad" onclick="recordStat(0, 'pf')">FOUL <span class="key-hint">F</span></button>
        <button class="btn c-bad" onclick="recordStat(0, 'to')">TO <span class="key-hint">T</span></button>
        <button class="btn c-stat" onclick="recordStat(0, 'reb')">REB <span class="key-hint">R</span></button>
        <button class="btn c-stat" onclick="recordStat(0, 'ast')">AST <span class="key-hint">A</span></button>
        <button class="btn c-stat" onclick="recordStat(0, 'stl')">STL <span class="key-hint">S</span></button>
        <button class="btn c-stat" onclick="recordStat(0, 'blk')">BLK <span class="key-hint">B</span></button>
        
        <button class="btn c-chart" onclick="openReviewChart()">üìä VIEW TEAM CHART</button>
    </div>

    <div id="shot-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modal-title">Record Shot</div>
            <div style="color:#555; font-size:0.9rem; margin-bottom:10px">Tap court location</div>
            <canvas id="court" width="300" height="280"></canvas>
            <div style="display:flex; justify-content:space-between; margin-top:10px;">
                <button onclick="printChart()" style="padding:8px; background:#673ab7; color:white; border:none; border-radius:4px;">üñ®Ô∏è Print Chart</button>
                <button onclick="document.getElementById('shot-modal').style.display='none'" style="padding:8px 20px;">Close</button>
            </div>
        </div>
    </div>

    <script>
        let stats = JSON.parse(localStorage.getItem('tiu_stats')) || {};
        let logs = JSON.parse(localStorage.getItem('tiu_logs')) || [];
        let score = JSON.parse(localStorage.getItem('tiu_score')) || { home:0, guest:0 };
        let shots = JSON.parse(localStorage.getItem('tiu_shots')) || [];
        let config = JSON.parse(localStorage.getItem('tiu_config')) || { foulLimit: 5 };
        
        let selectedId = null;
        let selectedName = "";
        let rosterCache = "";
        let pendingShot = { val: 0, type: '', reviewOnly: false };

        // --- KEYBOARD SHORTCUTS ---
        document.addEventListener('keydown', (e) => {
            if(document.getElementById('shot-modal').style.display === 'flex') {
                if(e.key === 'Escape') document.getElementById('shot-modal').style.display = 'none';
                return;
            }

            const key = e.key.toUpperCase();
            
            // Stats
            if(key === '1') triggerShot(1, 'fg');
            else if(key === '2') triggerShot(2, 'fg');
            else if(key === '3') triggerShot(3, 'fg');
            else if(key === '0' || key === 'M') triggerShot(0, 'miss');
            else if(key === 'F') recordStat(0, 'pf');
            else if(key === 'T') recordStat(0, 'to');
            else if(key === 'R') recordStat(0, 'reb');
            else if(key === 'A') recordStat(0, 'ast');
            else if(key === 'S') recordStat(0, 'stl');
            else if(key === 'B') recordStat(0, 'blk');
        });

        window.onload = () => { renderLogs(); updateScore(); };

        setInterval(() => {
            const time = localStorage.getItem('tiu_clock_display');
            const running = localStorage.getItem('tiu_is_running') === 'true';
            const rawRoster = localStorage.getItem('tiu_roster');
            const freshConfig = JSON.parse(localStorage.getItem('tiu_config'));
            if(freshConfig) config = freshConfig;

            document.getElementById('time-text').innerText = time || "00:00";
            const badge = document.getElementById('banner-clock');
            if(running) badge.classList.add('live'); else badge.classList.remove('live');

            if(rawRoster && rawRoster !== rosterCache) {
                rosterCache = rawRoster;
                renderRoster(JSON.parse(rawRoster));
            }
        }, 500);

        function renderRoster(list) {
            const grid = document.getElementById('roster-grid');
            grid.innerHTML = "";
            if(!list.length) { grid.innerHTML = "<div style='color:#aaa'>No players. Add in Rotation Page.</div>"; return; }

            list.forEach(p => {
                if(!stats[p.id]) stats[p.id] = { pts:0, reb:0, ast:0, stl:0, blk:0, to:0, pf:0, fgm:0, fga:0 };
                const s = stats[p.id];
                const isFouledOut = s.pf >= (config.foulLimit || 5);
                const div = document.createElement('div');
                div.className = `card ${selectedId === p.id ? 'selected' : ''} ${isFouledOut ? 'fouled-out' : ''}`;
                div.onclick = () => select(p.id, p.name);
                div.innerHTML = `<h3>${p.name}</h3><small>${s.pts} Pts ‚Ä¢ ${s.reb} Reb ‚Ä¢ ${s.pf} PF</small>${isFouledOut ? '<div style="color:#ff8a80; font-weight:bold; font-size:0.8rem">‚ö†Ô∏è FOULED OUT</div>' : ''}`;
                grid.appendChild(div);
            });
        }

        function select(id, name) {
            selectedId = id; selectedName = name;
            document.getElementById('selection-msg').innerHTML = `Selected: <b style="color:#4caf50">${name}</b>`;
            renderRoster(JSON.parse(rosterCache));
        }

        function adjGuest(val) {
            score.guest += val; if(score.guest < 0) score.guest = 0;
            updateScore(); save();
        }

        function updateScore() { 
            document.getElementById('score-home').innerText = score.home;
            document.getElementById('score-guest').innerText = score.guest;
        }

        function triggerShot(val, type) {
            if(!selectedId) { alert("Select a player first!"); return; }
            pendingShot = { val: val, type: type, reviewOnly: false };
            const title = document.getElementById('modal-title');
            if(type === 'miss') { title.innerText = "Record MISS"; title.style.color = "red"; }
            else { title.innerText = `Record ${val} PT MAKE`; title.style.color = "green"; }
            document.getElementById('shot-modal').style.display = 'flex';
            drawCourt();
        }

        function openReviewChart() {
            pendingShot = { reviewOnly: true };
            document.getElementById('modal-title').innerText = "Team Shot Chart";
            document.getElementById('modal-title').style.color = "black";
            document.getElementById('shot-modal').style.display = 'flex';
            drawCourt();
        }

        const cvs = document.getElementById('court');
        const ctx = cvs.getContext('2d');

        cvs.onclick = (e) => {
            if(pendingShot.reviewOnly) return;
            if(!selectedId) return;
            const rect = cvs.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const isMake = pendingShot.type !== 'miss';
            shots.push({ x, y, make: isMake, pid: selectedId, pName: selectedName });
            recordStat(pendingShot.val, pendingShot.type);
            document.getElementById('shot-modal').style.display = 'none';
        }

        function drawCourt() {
            ctx.fillStyle = "#e0bb86"; ctx.fillRect(0,0,300,280);
            ctx.strokeStyle = "white"; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.arc(150, 25, 5, 0, Math.PI*2); ctx.stroke(); 
            ctx.strokeRect(100, 0, 100, 100); 
            ctx.beginPath(); ctx.arc(150, 25, 110, 0, Math.PI, false); ctx.stroke();
            shots.forEach(s => {
                ctx.fillStyle = s.make ? "green" : "red";
                ctx.beginPath(); ctx.arc(s.x, s.y, 5, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "black"; ctx.font = "bold 10px Arial"; ctx.textAlign = "center";
                ctx.fillText(s.pName, s.x, s.y - 7);
            });
        }

        function printChart() {
            const win = window.open('', '', 'height=600,width=800');
            const img = cvs.toDataURL("image/png");
            win.document.write('<html><head><title>Shot Chart</title></head><body><h2 style="text-align:center">Team Shot Chart</h2><img src="' + img + '" style="display:block; margin:0 auto; border:2px solid black"/></body></html>');
            win.document.close();
            win.focus();
            setTimeout(() => win.print(), 500);
        }

        function recordStat(val, type) {
            if(!selectedId) { alert("Select a player first!"); return; }
            const p = JSON.parse(rosterCache).find(x => x.id === selectedId);
            const s = stats[selectedId];
            const time = document.getElementById('time-text').innerText;
            let txt = "";

            if(val > 0) {
                s.pts += val; s.fgm++; s.fga++; score.home += val;
                txt = `${p.name} Scored ${val} Pts`;
            } else if(type === 'miss') {
                s.fga++; txt = `${p.name} Missed`;
            } else {
                s[type]++; txt = `${p.name} ${type.toUpperCase()}`;
            }

            logs.unshift(`[${time}] ${txt}`);
            save(); renderLogs(); updateScore(); renderRoster(JSON.parse(rosterCache));
        }

        function renderLogs() { document.getElementById('logs').innerHTML = logs.map(l => `<li>${l}</li>`).join(''); }
        
        function save() {
            localStorage.setItem('tiu_stats', JSON.stringify(stats));
            localStorage.setItem('tiu_logs', JSON.stringify(logs));
            localStorage.setItem('tiu_score', JSON.stringify(score));
            localStorage.setItem('tiu_shots', JSON.stringify(shots));
        }

        function exportCSV() {
            const rows = [["Name", "PTS", "REB", "AST", "STL", "BLK", "TO", "PF", "FGM", "FGA"]];
            const pList = JSON.parse(rosterCache);
            pList.forEach(p => {
                const s = stats[p.id] || {};
                rows.push([p.name, s.pts||0, s.reb||0, s.ast||0, s.stl||0, s.blk||0, s.to||0, s.pf||0, s.fgm||0, s.fga||0]);
            });
            const encodedUri = encodeURI("data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n"));
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "game_stats.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>