<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIU Rotation & Time Tracker</title>
    <style>
        /* --- GLOBAL & THEME --- */
        :root {
            --primary: #1a237e;     /* Deep Blue */
            --accent: #ff6f00;      /* Basketball Orange */
            --bg: #f0f2f5;
            --success: #2e7d32;
            --danger: #c62828;
            --equity: #0097a7;
            --cashapp: #00D632;     /* Cash App Green */
            --dark-panel: #222;
        }
        
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg); 
            color: #333; 
            margin: 0; 
            padding: 0; 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh; 
        }

        /* --- NAVIGATION --- */
        .app-nav {
            background: var(--primary);
            display: flex;
            justify-content: center;
            padding: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .nav-btn {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.6);
            padding: 15px 20px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            border-bottom: 4px solid transparent;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        .nav-btn:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-btn.active { color: white; border-bottom-color: var(--accent); background: rgba(255,255,255,0.1); }
        
        /* Cash App Nav Button Style */
        .nav-btn.donate-btn { color: var(--cashapp); }
        .nav-btn.donate-btn:hover { color: #fff; text-shadow: 0 0 5px var(--cashapp); }

        /* --- SHARED COMPONENTS --- */
        .action-btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: 0.2s; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-orange { background: var(--accent); color: white; }
        .btn-red { background: var(--danger); color: white; }
        .btn-green { background: var(--success); color: white; }
        
        /* WIDE PANEL UPDATE */
        .panel { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 20px; margin: 20px auto; max-width: 95%; }

        /* ========================================= */
        /* TAB 1: ROTATION TRACKER STYLES */
        /* ========================================= */
        .tr-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .tr-brand h2 { margin: 0; color: var(--primary); }
        .clock-container { display: flex; flex-direction: column; align-items: flex-end; margin-left: 10px; }
        .game-clock { font-family: 'Courier New', monospace; font-size: 2rem; font-weight: bold; color: #333; }
        .clock-top-row { display: flex; align-items: center; }
        
        .mode-container { display: flex; justify-content: center; align-items: center; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 20px; gap: 15px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--equity); }
        input:checked + .slider:before { transform: translateX(22px); }

        .game-board { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .game-board { grid-template-columns: 1fr; } }
        .court-area, .bench-area { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ddd; }
        .court-area { border: 2px solid var(--primary); }

        .player-card { display: flex; align-items: center; background: #fff; border: 1px solid #eee; border-radius: 6px; padding: 10px; margin-bottom: 8px; }
        .pos-badge { background: #eee; color: #555; font-size: 0.75rem; font-weight: bold; padding: 4px; border-radius: 4px; margin-right: 10px; width: 35px; text-align: center; }
        .player-info { flex: 1; }
        .bar-container { height: 6px; background: #eee; border-radius: 3px; margin-top: 5px; width: 100%; overflow: hidden; }
        .status-bar { height: 100%; transition: width 0.5s, background-color 0.5s; }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 600px; padding: 20px; border-radius: 8px; text-align: center; }
        #notification { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); background: var(--success); color: white; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 2000; }
        
        .cash-app-btn {
            background-color: var(--cashapp);
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            padding: 12px 25px;
            border-radius: 30px;
            text-decoration: none;
            display: inline-block;
            margin: 15px 0;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .cash-app-btn:hover { transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }

        @media print {
            .app-nav, .add-controls, .data-controls, .mode-container, #coach-feedback { display: none !important; }
            body { background: white !important; }
            .panel { box-shadow: none; border: 1px solid #ccc; max-width: 100%; }
        }
    </style>
</head>
<body>

    <nav class="app-nav">
        <button class="nav-btn active">Rotation & Time</button>
        <a href="stat-recorder.html" class="nav-btn">Stat Recorder</a>
        <a href="play-designer.html" class="nav-btn">Play Designer</a>
        <button class="nav-btn" id="sound-toggle" onclick="toggleSound()" title="Toggle Sound">üîä</button>
        <button class="nav-btn donate-btn" onclick="openDonateModal()">$ Support</button>
    </nav>

    <div id="notification">Action Recorded</div>

    <div id="view-tracker" class="view-section">
        <div class="panel">
            <div class="tr-header">
                <div class="tr-brand">
                    <h2>Game Tracker</h2>
                    <span style="color:#777">Manage Substitutions & Fatigue</span>
                </div>
                <div class="clock-container">
                    <div class="clock-top-row">
                        <span style="background:var(--accent); color:white; padding:4px 8px; border-radius:4px;" id="quarter-display">Q1</span>
                        <span class="game-clock" id="clock-display">08:00</span>
                        <button class="action-btn btn-blue" onclick="openSettings()" style="background:#555; padding:4px 8px; margin-left:10px; border-radius: 50%; width: 30px; height: 30px; display:flex; justify-content:center; align-items:center;">‚öôÔ∏è</button>
                    </div>
                    <div style="font-size:0.8rem; margin-top:5px; color:#777;">
                        Home TO: <strong id="home-to-display">3</strong> | Guest TO: <strong id="guest-to-display">3</strong>
                    </div>
                </div>
            </div>

            <div class="mode-container">
                <span style="font-weight:bold; color:#777">Fatigue Mode</span>
                <label class="switch">
                    <input type="checkbox" id="mode-switch" onchange="toggleMode()">
                    <span class="slider round"></span>
                </label>
                <span style="font-weight:bold; color:#777">Equity Mode</span>
            </div>

            <div class="controls-row" style="display:flex; gap:10px; margin-bottom:20px; flex-wrap: wrap; justify-content: center;">
                <button id="game-toggle" class="action-btn btn-green" style="flex:2; padding:12px; font-size:1.1rem;" onclick="toggleGame()">Start Clock</button>
                <button id="next-q-btn" class="action-btn btn-blue" style="flex:1; display:none;" onclick="nextQuarter()">Start Next Q</button>
                <button class="action-btn btn-blue" onclick="openPlanner()">Auto-Plan</button>
                <button class="action-btn" style="background:#888; color:white;" onclick="callTimeout('home')">Home TO</button>
                <button class="action-btn" style="background:#888; color:white;" onclick="callTimeout('guest')">Guest TO</button>
            </div>

            <div id="coach-feedback" style="background:#e0f7fa; padding:10px; margin-bottom:15px; border-radius:4px; display:none; border-left:4px solid var(--equity);">
                <span id="feedback-text"></span>
                <button class="action-btn btn-blue" style="float:right; padding:4px 8px;" onclick="applySuggestion()">Swap</button>
            </div>

            <div class="game-board">
                <div class="court-area">
                    <h3 style="margin-top:0; border-bottom:1px solid #eee;">On Court <span id="court-count">0/5</span></h3>
                    <div id="court-list"></div>
                </div>
                <div class="bench-area">
                    <h3 style="margin-top:0; border-bottom:1px solid #eee;">Bench</h3>
                    <div id="bench-list"></div>
                </div>
            </div>

            <div class="add-controls" style="background:#f8f9fa; padding:15px; margin-top:20px; border-radius:8px; display:flex; gap:10px; justify-content:center; flex-wrap: wrap;">
                <input type="text" id="player-name" placeholder="New Player Name" style="padding:8px; flex: 1; min-width: 120px;">
                <select id="player-position" style="padding:8px;">
                    <option value="PG">PG</option><option value="SG">SG</option>
                    <option value="SF">SF</option><option value="PF">PF</option><option value="C">C</option>
                </select>
                <button class="action-btn btn-blue" onclick="addPlayer()">+ Add</button>
                <button class="action-btn btn-green" onclick="openBulkImport()">Bulk Import</button>
                <button class="action-btn btn-orange" onclick="generateRecommendation()">Suggest Sub</button>
            </div>

            <div class="data-controls" style="margin-top:20px; text-align:center;">
                <button class="action-btn" style="border:1px solid #ccc" onclick="exportTimeStats()">Export Time CSV</button>
                <button class="action-btn" style="border:1px solid #ccc" onclick="window.print()">Print Report</button>
                <button class="action-btn btn-red" onclick="resetAll()">New Game (Reset All)</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h3>Game Settings</h3>
            <div style="margin-bottom:15px;">
                <label for="setting-quarter-length" style="display:block; margin-bottom:5px; font-weight:bold;">Quarter Length (Minutes):</label>
                <input type="number" id="setting-quarter-length" min="1" max="15" value="8" style="padding:8px; width:100%; border:1px solid #ccc; border-radius:4px;">
            </div>
            <div style="margin-bottom:15px;">
                <label for="setting-timeouts" style="display:block; margin-bottom:5px; font-weight:bold;">Total Timeouts (Per Team):</label>
                <input type="number" id="setting-timeouts" min="0" max="10" value="3" style="padding:8px; width:100%; border:1px solid #ccc; border-radius:4px;">
            </div>
            <button class="action-btn btn-green" onclick="saveSettings()" style="width:100%; margin-bottom:10px;">Save Settings & Reset Game</button>
            <button class="action-btn" onclick="document.getElementById('settings-modal').style.display='none'" style="width:100%; border:1px solid #ccc;">Close</button>
        </div>
    </div>
    
    <div id="donate-modal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--primary); margin-top:0;">Support the App</h2>
            <p>If you find this tool useful, consider supporting future development!</p>
            
            <a href="https://cash.app/$AnthonyTiu" target="_blank" class="cash-app-btn">
                $ Donate via Cash App
            </a>
            
            <p style="font-size:0.8rem; color:#666;">(Links open in a new tab)</p>
            <button class="action-btn btn-gray" onclick="closeDonateModal()">Close</button>
        </div>
    </div>
    
    <div id="planner-modal" class="modal">
        <div class="modal-content">
            <h3>Auto-Scheduler</h3>
            <p>Generates a fair rotation plan for 8 shifts (start and middle of each quarter).</p>
            <button class="action-btn btn-blue" onclick="generatePlan()">Generate</button>
            <button class="action-btn" onclick="document.getElementById('planner-modal').style.display='none'">Close</button>
            <div id="plan-container" style="margin-top:15px; max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>

    <div id="bulk-modal" class="modal">
        <div class="modal-content">
            <h3>Bulk Import Roster</h3>
            <p>Paste list below. Format: <b>Name, Position</b> per line.<br><small>Example: LeBron James, SF</small></p>
            <textarea id="bulk-input" rows="8" style="width:100%; margin-bottom:10px; padding:10px; font-family:monospace;" placeholder="John Doe, PG&#10;Jane Smith, C"></textarea>
            <button class="action-btn btn-green" style="width:100%; margin-bottom:10px;" onclick="processBulkImport()">Import Players</button>
            <button class="action-btn btn-red" style="width:100%;" onclick="document.getElementById('bulk-modal').style.display='none'">Cancel</button>
        </div>
    </div>

    <script>
        const STORE_KEY = 'tiu_ultimate_suite_v2'; 
        let trPlayers = []; let stPlayers = []; let statHistory = [];
        let currentQuarter = 1; let gameSeconds = 8 * 60; let gameActive = false;
        let timerInterval = null; let equityMode = false;
        let quarterLengthInMinutes = 8; let totalTimeoutsPerTeam = 3; 
        let homeTimeoutsRemaining = 3; let guestTimeoutsRemaining = 3;

        // --- SOUND ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let soundEnabled = true;

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('sound-toggle');
            if(btn) btn.textContent = soundEnabled ? "üîä" : "üîá";
        }

        function playSound(type) {
            if (!soundEnabled) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode); gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'click') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'whistle') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(2000, now); osc.frequency.linearRampToValueAtTime(1500, now + 0.3);
                gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'buzzer') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now);
                gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.linearRampToValueAtTime(0, now + 1.5);
                osc.start(now); osc.stop(now + 1.5);
            } else if (type === 'success') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.setValueAtTime(600, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            }
        }

        window.onload = () => {
            loadData();
            const modeSwitch = document.getElementById('mode-switch');
            if (modeSwitch) equityMode = modeSwitch.checked;
        };

        function loadData() {
            const saved = localStorage.getItem(STORE_KEY);
            if(saved) {
                const data = JSON.parse(saved);
                trPlayers = data.trPlayers || [];
                stPlayers = data.stPlayers || [];
                currentQuarter = data.currentQuarter || 1;
                quarterLengthInMinutes = data.quarterLengthInMinutes || 8;
                totalTimeoutsPerTeam = data.totalTimeoutsPerTeam || 3;
                homeTimeoutsRemaining = data.homeTimeoutsRemaining !== undefined ? data.homeTimeoutsRemaining : totalTimeoutsPerTeam;
                guestTimeoutsRemaining = data.guestTimeoutsRemaining !== undefined ? data.guestTimeoutsRemaining : totalTimeoutsPerTeam;
                gameSeconds = data.gameSeconds !== undefined && data.gameSeconds > 0 ? data.gameSeconds : quarterLengthInMinutes * 60;
                statHistory = data.statHistory || [];
            }
            renderTracker(); updateClockUI(); updateTimeoutsUI();
        }

        function saveData() {
            const data = { trPlayers, stPlayers, currentQuarter, gameSeconds, statHistory, quarterLengthInMinutes, totalTimeoutsPerTeam, homeTimeoutsRemaining, guestTimeoutsRemaining };
            localStorage.setItem(STORE_KEY, JSON.stringify(data));
        }

        function resetAll() {
            if(confirm("Clear ALL data and Roster?")) {
                localStorage.removeItem(STORE_KEY); location.reload();
            }
        }
        function formatTime(s) {
            const m = Math.floor(s/60); const sec = s%60;
            return `${m}:${sec<10?'0':''}${sec}`;
        }
        function showNotif(msg) {
            const n = document.getElementById('notification'); n.innerText = msg; n.style.opacity = 1;
            setTimeout(() => n.style.opacity = 0, 2000);
        }
        function downloadCSV(content, filename) {
            const blob = new Blob([content], {type:'text/csv;charset=utf-8;'});
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = filename; link.click();
        }

        function addPlayer() {
            const name = document.getElementById('player-name').value.trim();
            const pos = document.getElementById('player-position').value;
            if(!name) return;
            createPlayer(name, pos);
            playSound('click');
            document.getElementById('player-name').value = ''; showNotif(`Added ${name}`);
        }
        function createPlayer(name, pos) {
            const newId = Date.now() + Math.random();
            trPlayers.push({ id: newId, name: name, position: pos, totalTime: 0, currentFatigue: 0, isOnCourt: false, recoveryCounter: 0 });
            stPlayers.push({ id: newId, name: name, stats: { ft: 0, fg: 0, zp: 0, reb: 0, ast: 0, stl: 0, blk: 0, to: 0, pf: 0 } });
            saveData(); renderTracker();
        }
        function openBulkImport() { playSound('click'); document.getElementById('bulk-modal').style.display = 'flex'; }
        function processBulkImport() {
            const raw = document.getElementById('bulk-input').value; if(!raw.trim()) return;
            const lines = raw.split('\n');
            lines.forEach(line => {
                const parts = line.split(',');
                if(parts.length > 0 && parts[0].trim()) {
                    const name = parts[0].trim();
                    const pos = parts[1] ? parts[1].trim().toUpperCase() : 'PG'; 
                    createPlayer(name, pos);
                }
            });
            playSound('success');
            document.getElementById('bulk-modal').style.display = 'none'; document.getElementById('bulk-input').value = '';
        }

        function toggleGame() {
            if(gameSeconds <= 0 && !gameActive) return;
            gameActive = !gameActive;
            playSound('whistle');
            const btn = document.getElementById('game-toggle');
            if(gameActive) {
                btn.textContent = "Pause Clock"; btn.className = "action-btn btn-red";
                document.getElementById('next-q-btn').style.display = 'none';
                timerInterval = setInterval(gameTick, 1000);
            } else {
                btn.textContent = "Resume Clock"; btn.className = "action-btn btn-green";
                clearInterval(timerInterval); saveData();
            }
        }
        function gameTick() {
            if(gameSeconds > 0) {
                gameSeconds--; updateClockUI();
                trPlayers.forEach(p => {
                    if(p.isOnCourt) { p.totalTime++; p.currentFatigue++; } 
                    else { p.recoveryCounter++; if(p.recoveryCounter >= 4) { if(p.currentFatigue > 0) p.currentFatigue--; p.recoveryCounter = 0; } }
                });
                renderTracker();
                if(gameSeconds % 10 === 0) saveData(); 
            } else {
                toggleGame();
                playSound('buzzer');
                document.getElementById('game-toggle').textContent = "End of Quarter";
                document.getElementById('next-q-btn').style.display = 'block';
                alert("Quarter Ended");
            }
        }
        function nextQuarter() {
            currentQuarter++; gameSeconds = quarterLengthInMinutes * 60;
            document.getElementById('quarter-display').textContent = "Q" + currentQuarter;
            updateClockUI(); document.getElementById('next-q-btn').style.display = 'none';
            document.getElementById('game-toggle').textContent = "Start Clock"; document.getElementById('game-toggle').className = "action-btn btn-green";
            trPlayers.forEach(p => { p.currentFatigue = Math.max(0, p.currentFatigue - 30); });
            playSound('whistle');
            saveData(); renderTracker();
        }
        function updateClockUI() {
            const m = Math.floor(gameSeconds / 60); const s = gameSeconds % 60;
            document.getElementById('clock-display').textContent = `${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
        }
        function updateTimeoutsUI() {
            document.getElementById('home-to-display').textContent = homeTimeoutsRemaining;
            document.getElementById('guest-to-display').textContent = guestTimeoutsRemaining;
        }
        function callTimeout(team) {
            playSound('click');
            if (!gameActive) { showNotif("Clock is not running."); return; }
            if (team === 'home') {
                if (homeTimeoutsRemaining > 0) { homeTimeoutsRemaining--; toggleGame(); showNotif(`Home Timeout! ${homeTimeoutsRemaining} left.`); } 
                else { showNotif("Home has no timeouts."); return; }
            } else if (team === 'guest') {
                if (guestTimeoutsRemaining > 0) { guestTimeoutsRemaining--; toggleGame(); showNotif(`Guest Timeout! ${guestTimeoutsRemaining} left.`); }
                else { showNotif("Guest has no timeouts."); return; }
            }
            updateTimeoutsUI(); saveData();
        }
        function toggleMode() { playSound('click'); equityMode = document.getElementById('mode-switch').checked; renderTracker(); }
        function subPlayer(id) {
            playSound('click');
            const p = trPlayers.find(x => x.id === id); const onCourt = trPlayers.filter(x => x.isOnCourt).length;
            if(!p.isOnCourt && onCourt >= 5) { alert("Court is full (5 players). Sub someone out first."); return; }
            p.isOnCourt = !p.isOnCourt; saveData(); renderTracker();
        }
        function renderTracker() {
            const courtList = document.getElementById('court-list'); const benchList = document.getElementById('bench-list');
            courtList.innerHTML = ''; benchList.innerHTML = '';
            document.getElementById('court-count').innerText = `${trPlayers.filter(p=>p.isOnCourt).length}/5`;
            let courtP = trPlayers.filter(p => p.isOnCourt); let benchP = trPlayers.filter(p => !p.isOnCourt);
            if(equityMode) { courtP.sort((a,b) => b.totalTime - a.totalTime); benchP.sort((a,b) => a.totalTime - b.totalTime); } 
            else { courtP.sort((a,b) => b.currentFatigue - a.currentFatigue); benchP.sort((a,b) => a.currentFatigue - b.currentFatigue); }
            const createCard = (p) => {
                const elapsed = ((currentQuarter-1)*quarterLengthInMinutes*60) + ((quarterLengthInMinutes*60) - gameSeconds);
                let pct, color;
                if(equityMode) { pct = (p.totalTime / Math.max(1, elapsed)) * 100; color = 'var(--equity)'; } 
                else { pct = Math.max(0, 100 - ((p.currentFatigue/(quarterLengthInMinutes*60))*100)); color = pct<30 ? 'var(--danger)' : (pct<60?'#fbc02d':'var(--success)'); }
                return `<div class="player-card"><div class="pos-badge">${p.position}</div><div class="player-info"><strong>${p.name}</strong> <span style="color:#777; font-size:0.8rem">(${formatTime(p.totalTime)})</span><div class="bar-container"><div class="status-bar" style="width:${Math.min(100, pct)}%; background:${color}"></div></div></div><button class="action-btn ${p.isOnCourt?'':'btn-green'}" style="margin-left:10px; background:${p.isOnCourt?'#eee':'var(--primary)'}; color:${p.isOnCourt?'#333':'white'}" onclick="subPlayer(${p.id})">${p.isOnCourt ? 'Sit' : 'Play'}</button></div>`;
            };
            courtP.forEach(p => courtList.innerHTML += createCard(p)); benchP.forEach(p => benchList.innerHTML += createCard(p));
        }
        function openSettings() { 
            playSound('click');
            document.getElementById('setting-quarter-length').value = quarterLengthInMinutes;
            document.getElementById('setting-timeouts').value = totalTimeoutsPerTeam;
            document.getElementById('settings-modal').style.display = 'flex'; 
        }
        function saveSettings() {
            if(gameActive && !confirm("Game is active. Saving settings will reset the clock. Continue?")) return;
            quarterLengthInMinutes = parseInt(document.getElementById('setting-quarter-length').value);
            totalTimeoutsPerTeam = parseInt(document.getElementById('setting-timeouts').value);
            if(gameActive) toggleGame();
            currentQuarter = 1; gameSeconds = quarterLengthInMinutes * 60;
            homeTimeoutsRemaining = totalTimeoutsPerTeam; guestTimeoutsRemaining = totalTimeoutsPerTeam;
            document.getElementById('quarter-display').textContent = "Q1";
            updateClockUI(); updateTimeoutsUI(); saveData(); showNotif("Settings Saved");
            document.getElementById('settings-modal').style.display = 'none';
        }
        function openPlanner() { playSound('click'); document.getElementById('planner-modal').style.display = 'flex'; }
        function generatePlan() {
            const p = [...trPlayers]; if(p.length < 5) { alert("Need 5+ players"); return; }
            let html = "<table style='width:100%; border-collapse:collapse;'><tr><th>Period</th><th>Lineup</th></tr>";
            for(let i=0; i<8; i++) {
                const lineup = []; for(let j=0; j<5; j++) lineup.push(p[(i*5 + j) % p.length].name);
                html += `<tr><td style='border:1px solid #ddd; padding:5px;'>${i%2==0?'Start':'Mid'} Q${Math.floor(i/2)+1}</td><td style='border:1px solid #ddd; padding:5px;'>${lineup.join(', ')}</td></tr>`;
            }
            document.getElementById('plan-container').innerHTML = html + "</table>";
        }
        function generateRecommendation() {
            playSound('click');
            const c = trPlayers.filter(p=>p.isOnCourt); const b = trPlayers.filter(p=>!p.isOnCourt); if(!c.length || !b.length) return;
            c.sort((x,y) => y.currentFatigue - x.currentFatigue); b.sort((x,y) => x.currentFatigue - y.currentFatigue);
            document.getElementById('feedback-text').innerHTML = `Sub OUT <b>${c[0].name}</b>, IN <b>${b[0].name}</b>`;
            document.getElementById('coach-feedback').style.display = 'block';
            window.pendingSub = { out: c[0].id, in: b[0].id };
            playSound('success');
        }
        function applySuggestion() {
            if(window.pendingSub) { subPlayer(window.pendingSub.out); subPlayer(window.pendingSub.in); document.getElementById('coach-feedback').style.display = 'none'; }
        }
        function exportTimeStats() {
            let csv = "Name,Pos,TimeFormatted,Seconds\n";
            trPlayers.forEach(p => csv += `${p.name},${p.position},${formatTime(p.totalTime)},${p.totalTime}\n`);
            downloadCSV(csv, "TIU_TimeStats.csv");
        }

        // --- DONATE MODAL LOGIC ---
        function openDonateModal() { document.getElementById('donate-modal').style.display = 'flex'; }
        function closeDonateModal() { document.getElementById('donate-modal').style.display = 'none'; }
    </script>
</body>
</html>