<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rotation Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #222; --text: #eee; --card-bg: #333; --green: #2e7d32; --red: #c62828; --blue: #1565c0; --gold: #ff8f00; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 10px; display: flex; flex-direction: column; height: 98vh; margin:0; overflow: hidden; }
        
        /* HEADER */
        .header { 
            background: #111; padding: 8px 15px; border-radius: 6px; 
            display: flex; justify-content: space-between; align-items: center; 
            border: 1px solid #444; flex-shrink: 0;
        }
        .header h2 { margin: 0; font-size: 1.2rem; }
        
        /* DASHBOARD */
        .dashboard {
            display: flex; gap: 15px; background: black; padding: 8px 15px; margin-top: 10px;
            border-radius: 6px; border: 1px solid #444; align-items: center; flex-shrink: 0;
            justify-content: space-between; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .clock-section { display: flex; align-items: center; gap: 15px; }
        
        /* DIGITAL CLOCK STYLE */
        .clock-display { 
            font-size: 2.5rem; font-family: 'Roboto Mono', monospace; font-weight: 700; 
            color: white; line-height: 1; letter-spacing: 2px;
            background: #111; padding: 5px 10px; border-radius: 4px; border: 1px solid #333;
        }
        .clock-display.active { color: #00e676; border-color: #00e676; text-shadow: 0 0 8px rgba(0,230,118,0.4); }
        .q-badge { background: #333; padding: 4px 8px; border-radius: 4px; font-weight: bold; color: #aaa; font-size: 1.2rem; }

        .tracker-section { display: flex; gap: 20px; font-size: 0.8rem; border-left: 1px solid #444; padding-left: 20px; }
        .tracker-group { display: flex; flex-direction: column; gap: 4px; }
        .tracker-row { display: flex; align-items: center; gap: 6px; }
        .adj-btn { width: 22px; height: 22px; background: #444; color: white; border: none; border-radius: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .adj-btn:hover { background: #666; }

        .to-dot { width: 10px; height: 10px; background: #444; border-radius: 50%; display: inline-block; }
        .to-dot.active { background: var(--gold); box-shadow: 0 0 5px var(--gold); }
        
        .control-section { display: flex; gap: 8px; }

        /* COURT */
        .court-container { display: flex; gap: 10px; flex: 1; overflow: hidden; margin-top: 10px; }
        .column { flex: 1; background: #1a1a1a; padding: 5px; border-radius: 6px; display: flex; flex-direction: column; border: 1px solid #444; }
        .col-header { text-align: center; font-weight: bold; padding: 5px; border-bottom: 1px solid #333; margin-bottom: 5px; font-size: 0.9rem; text-transform: uppercase; }

        #court-list, #bench-list { overflow-y: auto; flex: 1; padding-right: 2px; }
        
        .player-card { 
            background: var(--card-bg); padding: 6px 8px; margin-bottom: 5px; border-radius: 4px; 
            cursor: pointer; border-left: 3px solid #555; position: relative; font-size: 0.9rem;
        }
        .player-card:hover { background: #444; }
        .player-card.active { border-left-color: var(--green); background: #263238; }

        .card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;}
        .card-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }

        /* BARS WITH NUMBERS */
        .bars-container { display: flex; flex-direction: column; gap: 3px; }
        
        .bar-row { display: flex; align-items: center; gap: 5px; font-size: 0.75rem; color: #aaa; }
        .bar-label { width: 45px; flex-shrink: 0; }
        
        .bar-track { flex: 1; height: 12px; background: #111; border-radius: 3px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; transition: width 0.5s; position: absolute; left: 0; top: 0; }
        .fill-fatigue { background: linear-gradient(90deg, #66bb6a, #ffeb3b, #f44336); }
        .fill-equity { background: var(--blue); }
        
        /* The number overlay */
        .bar-text { 
            position: absolute; width: 100%; text-align: center; 
            font-size: 0.65rem; color: white; line-height: 12px; 
            text-shadow: 0 0 2px black; font-weight: bold; z-index: 2;
        }

        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; font-size: 0.85rem; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-green { background: var(--green); }
        .btn-red { background: var(--red); }
        .btn-blue { background: var(--blue); }
        .btn-gray { background: #555; }
        .btn-gold { background: var(--gold); color: black; }
        .btn-mute { background: #444; width: 40px; } 

        /* MODALS */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000; }
        .modal-box { background: #333; padding: 20px; border-radius: 8px; width: 400px; max-width: 90%; }
        textarea { width: 100%; height: 100px; background: #222; color: white; border: 1px solid #555; padding: 10px; margin: 10px 0; }
        input[type="number"] { padding: 5px; background: #222; border: 1px solid #555; color: white; width: 60px; }

        @media print {
            body { background: white; color: black; display: block; height: auto; overflow: visible; }
            .header, .dashboard, .btn, .modal { display: none !important; }
            .column { background: white; border: 1px solid #ccc; color: black; margin-bottom: 20px; }
            .player-card { background: white; border: 1px solid #ddd; color: black; page-break-inside: avoid; }
            .bar-track { background: #eee; }
            .bar-text { color: black; text-shadow: none; }
            .court-container { display: block; }
            .col-header { color: black !important; border-bottom: 2px solid black; }
        }
    </style>
</head>
<body>

    <div class="header">
        <h2>Rotation Manager</h2>
        <div style="display:flex; gap:5px;">
            <button class="btn btn-blue" onclick="toggleModal('settings-modal')" title="Settings">‚öôÔ∏è</button>
            <button class="btn btn-gray" id="sound-btn" onclick="toggleSound()" title="Toggle Sound">üîä</button>
            <button class="btn btn-gray" onclick="window.print()" title="Print Current Rotation">üñ®Ô∏è Print</button>
            <button class="btn btn-gold" onclick="generateGamePlan()">üìã Plan</button>
            <button class="btn btn-gray" onclick="toggleModal('bulk-modal')">üìù Add</button>
            <button class="btn btn-gray" onclick="exportData()">üíæ Save</button>
            <label class="btn btn-gray" style="cursor:pointer">
                üìÇ <input type="file" hidden onchange="importData(this)">
            </label>
        </div>
    </div>

    <div class="dashboard">
        <div class="clock-section">
            <div class="clock-display" id="clock">08:00</div>
            <div class="q-badge" id="q-val">Q1</div>
            <button class="btn btn-gray" style="padding:4px 8px" onclick="playAudio('buzzer')" title="Sound Horn">üîä</button>
        </div>

        <div class="tracker-section">
            <div class="tracker-group">
                <div style="color:#aaa; font-size:0.7rem">TIMEOUTS</div>
                <div class="tracker-row">
                    <button class="adj-btn" onclick="adjTO(-1)">-</button>
                    <span id="to-dots" style="white-space:nowrap"></span>
                    <button class="adj-btn" onclick="adjTO(1)">+</button>
                    <small onclick="resetTimeouts()" style="cursor:pointer; color:#888; margin-left:2px" title="Reset">‚Ü∫</small>
                </div>
            </div>
            <div class="tracker-group">
                <div style="color:#aaa; font-size:0.7rem">TEAM FOULS</div>
                <div class="tracker-row">
                    <button class="adj-btn" onclick="adjFouls(-1)">-</button>
                    <span id="team-fouls" style="font-weight:bold; min-width:15px; text-align:center">0</span>
                    <button class="adj-btn" onclick="adjFouls(1)">+</button>
                </div>
            </div>
        </div>

        <div class="control-section">
            <button class="btn btn-green" onclick="toggleClock(true)">‚ñ∂ START</button>
            <button class="btn btn-red" onclick="toggleClock(false)">‚è∏ STOP</button>
            <button class="btn btn-gray" onclick="resetClock()">‚Ü∫ RESET</button>
            <button class="btn btn-gold" onclick="nextQ()">NEXT Q</button>
        </div>
    </div>

    <div class="court-container">
        <div class="column">
            <div class="col-header" style="color:#66bb6a">On Court</div>
            <div id="court-list"></div>
        </div>
        <div class="column">
            <div class="col-header" style="color:#bdbdbd">Bench</div>
            <div id="bench-list"></div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-box">
            <h3>Settings</h3>
            <div style="margin-bottom:10px; display:flex; justify-content:space-between;">
                <label>Qtr Length (min):</label><input type="number" id="cfg-qlen" value="8">
            </div>
            <div style="margin-bottom:10px; display:flex; justify-content:space-between;">
                <label>Timeouts:</label><input type="number" id="cfg-max-to" value="3">
            </div>
            <div style="margin-bottom:15px; display:flex; justify-content:space-between;">
                <label>Foul Limit:</label><input type="number" id="cfg-foul-limit" value="5">
            </div>
            <div style="text-align:right">
                <button class="btn btn-gray" onclick="toggleModal('settings-modal')">Cancel</button>
                <button class="btn btn-green" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <div id="bulk-modal" class="modal">
        <div class="modal-box">
            <h3>Add Players</h3>
            <textarea id="bulk-text" placeholder="Paste names here..."></textarea>
            <div style="text-align:right">
                <button class="btn btn-gray" onclick="toggleModal('bulk-modal')">Cancel</button>
                <button class="btn btn-green" onclick="processBulk()">Add</button>
            </div>
        </div>
    </div>

    <div id="plan-modal" class="modal">
        <div class="modal-box" style="width:500px">
            <h3>Rotation Plan</h3>
            <div id="plan-content" style="max-height:300px; overflow-y:auto; margin-bottom:10px; font-size:0.9rem"></div>
            <button class="btn btn-gray" onclick="toggleModal('plan-modal')">Close</button>
            <button class="btn btn-blue" onclick="window.print()">Print Plan</button>
        </div>
    </div>

    <script>
        // --- DATA & SAFETY CHECKS ---
        let roster = JSON.parse(localStorage.getItem('tiu_roster')) || [];
        let config = JSON.parse(localStorage.getItem('tiu_config')) || { qLen: 8, maxTO: 3, foulLimit: 5 };
        
        let savedClock = JSON.parse(localStorage.getItem('tiu_clock_data'));
        
        // Strict Validation to prevent NaN
        let clock = { min: config.qLen, sec: 0, run: false, q: 1 };
        
        if (savedClock && !isNaN(savedClock.min) && !isNaN(savedClock.sec) && !isNaN(savedClock.q)) {
            clock = savedClock;
        }

        let timeouts = config.maxTO; 
        let teamFouls = 0;
        let timerInt = null;

        // --- SOUND SYSTEM ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let soundEnabled = JSON.parse(localStorage.getItem('tiu_sound')) ?? true; // Default to true

        function toggleSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('tiu_sound', soundEnabled);
            updateSoundUI();
        }

        function updateSoundUI() {
            const btn = document.getElementById('sound-btn');
            if(soundEnabled) {
                btn.innerHTML = "üîä";
                btn.style.opacity = "1";
            } else {
                btn.innerHTML = "üîá";
                btn.style.opacity = "0.6";
            }
        }

        function playAudio(type) {
            if (!soundEnabled) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'buzzer') {
                // Long Horn
                osc.type = 'sawtooth'; 
                osc.frequency.setValueAtTime(150, now); 
                osc.frequency.linearRampToValueAtTime(100, now + 1); 
                gainNode.gain.setValueAtTime(0.5, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 1.5);
                osc.start(now);
                osc.stop(now + 1.5);
            } 
            else if (type === 'whistle') {
                // Short Whistle/Beep for Start/Stop/NextQ
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.15);
                gainNode.gain.setValueAtTime(0.3, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            }
        }

        window.onload = () => { 
            document.getElementById('cfg-qlen').value = config.qLen;
            document.getElementById('cfg-max-to').value = config.maxTO;
            document.getElementById('cfg-foul-limit').value = config.foulLimit;
            render(); renderTimeouts(); updateSoundUI();
            if(clock.run) toggleClock(true);
        };

        function toggleClock(state) {
            clock.run = state;
            updateUI();
            playAudio('whistle'); // Play whistle on start/stop
            if(state) {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                clearInterval(timerInt);
                timerInt = setInterval(tick, 1000);
            } else {
                clearInterval(timerInt);
                save();
            }
        }

        function tick() {
            // Self-healing: if corrupted during runtime, reset
            if(isNaN(clock.min) || isNaN(clock.sec)) { 
                clock.min = config.qLen; clock.sec = 0; 
                toggleClock(false);
            }

            if(clock.sec === 0) {
                if(clock.min === 0) { 
                    toggleClock(false); 
                    playAudio('buzzer'); // Automatic buzzer
                    return; 
                }
                clock.min--; clock.sec = 59;
            } else { clock.sec--; }
            
            roster.forEach(p => { 
                if(p.onCourt) { 
                    p.shiftTime=(p.shiftTime||0)+1; 
                    p.totalTime=(p.totalTime||0)+1; 
                }
            });
            save(); render();
        }

        function resetClock() { 
            toggleClock(false); 
            clock.min = config.qLen; 
            clock.sec = 0; 
            save(); 
            render(); 
        }
        
        function nextQ() { 
            toggleClock(false); clock.q++; clock.min=config.qLen; clock.sec=0; 
            roster.forEach(p => p.shiftTime=0); 
            teamFouls = 0; document.getElementById('team-fouls').innerText = 0;
            playAudio('whistle');
            save(); render(); 
        }

        function render() {
            const m = (isNaN(clock.min) ? config.qLen : clock.min);
            const s = (isNaN(clock.sec) ? 0 : clock.sec);
            document.getElementById('clock').innerText = `${m}:${s.toString().padStart(2,'0')}`;
            document.getElementById('q-val').innerText = "Q" + clock.q;
            
            const cList = document.getElementById('court-list');
            const bList = document.getElementById('bench-list');
            cList.innerHTML = ""; bList.innerHTML = "";

            roster.forEach(p => {
                const fmt = (time) => {
                    if (isNaN(time)) return "0:00";
                    const tm = Math.floor(time/60);
                    const ts = (Math.floor(time)%60).toString().padStart(2,'0');
                    return `${tm}:${ts}`;
                };
                
                // Visual percentages
                const fPct = Math.min(100, (p.shiftTime/300)*100);
                const ePct = Math.min(100, (p.totalTime/1200)*100); 

                const div = document.createElement('div');
                div.className = `player-card ${p.onCourt ? 'active' : ''}`;
                div.onclick = () => togglePlayer(p.id);
                div.innerHTML = `
                    <div class="card-top">
                        <span class="card-name">${p.name}</span> 
                    </div>
                    <div class="bars-container">
                        <div class="bar-row">
                            <span class="bar-label">Shift</span>
                            <div class="bar-track">
                                <span class="bar-text">${fmt(p.shiftTime)}</span>
                                <div class="bar-fill fill-fatigue" style="width:${fPct}%"></div>
                            </div>
                        </div>
                        <div class="bar-row">
                            <span class="bar-label">Total</span>
                            <div class="bar-track">
                                <span class="bar-text">${fmt(p.totalTime)}</span>
                                <div class="bar-fill fill-equity" style="width:${ePct}%"></div>
                            </div>
                        </div>
                    </div>
                `;
                if(p.onCourt) cList.appendChild(div); else bList.appendChild(div);
            });
            updateUI();
        }

        function togglePlayer(id) {
            const p = roster.find(x => x.id === id);
            if(p) {
                if(!p.onCourt && roster.filter(x=>x.onCourt).length >= 5) { alert("‚ö†Ô∏è 5 Players Max!"); return; }
                p.onCourt = !p.onCourt;
                if(!p.onCourt) p.shiftTime = 0;
                save(); render();
            }
        }

        function saveSettings() {
            const ql = parseInt(document.getElementById('cfg-qlen').value);
            if(ql > 0) {
                config.qLen = ql;
                // If clock is stopped and sitting at old max, update it
                if(!clock.run && clock.min > ql) clock.min = ql;
            }
            config.maxTO = parseInt(document.getElementById('cfg-max-to').value);
            config.foulLimit = parseInt(document.getElementById('cfg-foul-limit').value);
            localStorage.setItem('tiu_config', JSON.stringify(config));
            toggleModal('settings-modal');
            renderTimeouts();
            render();
        }

        function adjTO(val) {
            timeouts += val;
            if(timeouts < 0) timeouts = 0;
            if(timeouts > config.maxTO) timeouts = config.maxTO;
            renderTimeouts();
        }
        function resetTimeouts() { timeouts = config.maxTO; renderTimeouts(); }
        function renderTimeouts() {
            let html = "";
            for(let i=0; i<config.maxTO; i++) html += `<span class="to-dot ${i<timeouts?'active':''}"></span>`;
            document.getElementById('to-dots').innerHTML = html;
        }

        function adjFouls(val) {
            teamFouls += val;
            if(teamFouls < 0) teamFouls = 0;
            const el = document.getElementById('team-fouls');
            el.innerText = teamFouls;
            el.style.color = teamFouls >= 5 ? "#ff8f00" : "white";
        }

        function processBulk() {
            const txt = document.getElementById('bulk-text').value;
            txt.split('\n').forEach(n => { if(n.trim()) roster.push({ id: Date.now()+Math.random(), name: n.trim(), onCourt: false, shiftTime:0, totalTime:0 }); });
            document.getElementById('bulk-text').value = ""; toggleModal('bulk-modal'); save(); render();
        }

        function save() {
            localStorage.setItem('tiu_roster', JSON.stringify(roster));
            localStorage.setItem('tiu_clock_data', JSON.stringify(clock));
            localStorage.setItem('tiu_clock_display', `${clock.min}:${clock.sec.toString().padStart(2,'0')}`);
            localStorage.setItem('tiu_is_running', clock.run);
        }

        function updateUI() {
            const el = document.getElementById('clock');
            if(clock.run) el.classList.add('active'); else el.classList.remove('active');
        }

        function toggleModal(id) { const m = document.getElementById(id); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; }
        
        function exportData() {
            const blob = new Blob([JSON.stringify({roster,clock})], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'rotation.json'; a.click();
        }
        function importData(inp) {
            const r = new FileReader(); r.onload=e=>{ const d=JSON.parse(e.target.result); roster=d.roster||[]; clock=d.clock||clock; save(); render(); };
            r.readAsText(inp.files[0]);
        }
        function generateGamePlan() {
            if(roster.length < 5) return;
            const periods = ["Q1 Start", "Q1 Mid", "Q2 Start", "Q2 Mid", "Q3 Start", "Q3 Mid", "Q4 Start", "Q4 Mid"];
            let html = "<table style='width:100%; border-collapse:collapse; color:white'>";
            let pIdx = 0;
            periods.forEach(per => {
                let lineup = [];
                for(let i=0; i<5; i++) { lineup.push(roster[pIdx % roster.length].name); pIdx++; }
                html += `<tr><td style='border:1px solid #555; padding:5px'>${per}</td><td style='border:1px solid #555; padding:5px; font-size:0.8rem'>${lineup.join(', ')}</td></tr>`;
            });
            html += "</table>";
            document.getElementById('plan-content').innerHTML = html;
            toggleModal('plan-modal');
        }
    </script>
</body>
</html>